<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VPN Map Viewer</title>
<style>
    body { margin: 0; background: black; color: white; font-family: Arial; }
    header { text-align: center; padding: 10px; }
    #controls { text-align: center; margin: 10px; }
    #controls button {
        margin: 5px;
        padding: 10px 20px;
        background: #444;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    #controls button:hover { background: #666; }
    #pdf-container {
        width: 100vw;
        height: calc(100vh - 100px);
        overflow: hidden;
        position: relative;
    }
    canvas {
        position: absolute;
        top: 0;
        left: 0;
        background: #222;
        transform-origin: 0 0;
        cursor: grab;
    }
    canvas:active {
        cursor: grabbing;
    }

    /* ✅ Loading Overlay */
    #loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        font-size: 18px;
    }
    #progress-bar {
        width: 60%;
        height: 20px;
        background: #333;
        border-radius: 10px;
        margin-top: 10px;
        overflow: hidden;
    }
    #progress-fill {
        width: 0%;
        height: 100%;
        background: #00ffcc;
        transition: width 0.2s;
    }
</style>
</head>
<body>
<header><h1>VPN Map (Who Owns Who)</h1></header>
<div id="controls">
    <button onclick="zoomIn()">Zoom In</button>
    <button onclick="zoomOut()">Zoom Out</button>
    <button onclick="resetView()">Reset</button>
</div>
<div id="pdf-container">
    <canvas id="pdf-render"></canvas>
    <div id="loading-overlay">
        <div>Loading VPN Map... <span id="progress-text">0%</span></div>
        <div id="progress-bar"><div id="progress-fill"></div></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
const url = 'https://raw.githubusercontent.com/Gooper0352-main/Ummsite/main/vpnmap.pdf';

let pdfDoc = null, pageNum = 1, zoom = 1, panX = 0, panY = 0;
const canvas = document.getElementById('pdf-render');
const ctx = canvas.getContext('2d');
const container = document.getElementById('pdf-container');
const loadingOverlay = document.getElementById('loading-overlay');
const progressFill = document.getElementById('progress-fill');
const progressText = document.getElementById('progress-text');

pdfjsLib.getDocument({
    url: url,
    rangeChunkSize: 65536, // 64KB chunks for faster progress updates
}).promise.then(pdf => {
    pdfDoc = pdf;
    renderLowRes(); // Fast low-res preview first
    renderPage(); // Full res after
}, err => {
    console.error(err);
});

function renderLowRes() {
    pdfDoc.getPage(pageNum).then(page => {
        const viewport = page.getViewport({ scale: 0.4 }); // Fast low-res
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        page.render({ canvasContext: ctx, viewport }).promise.then(() => {
            console.log('Low-res preview done');
        });
    });
}

function renderPage() {
    showLoading();
    pdfDoc.getPage(pageNum).then(page => {
        const viewport = page.getViewport({ scale: 1 }); // Full quality
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const renderContext = { canvasContext: ctx, viewport };
        page.render(renderContext).promise.then(() => {
            hideLoading();
            applyTransform();
        });
    });
}

function showLoading() { loadingOverlay.style.display = 'flex'; }
function hideLoading() { loadingOverlay.style.display = 'none'; }

function applyTransform() {
    canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
}

function zoomIn() { zoom += 0.2; applyTransform(); }
function zoomOut() { zoom = Math.max(0.2, zoom - 0.2); applyTransform(); }
function resetView() { zoom = 1; panX = 0; panY = 0; applyTransform(); }

// ✅ Drag to pan
let isDragging = false, startX, startY;
container.addEventListener('mousedown', e => {
    isDragging = true;
    startX = e.clientX - panX;
    startY = e.clientY - panY;
});
container.addEventListener('mousemove', e => {
    if (!isDragging) return;
    panX = e.clientX - startX;
    panY = e.clientY - startY;
    applyTransform();
});
window.addEventListener('mouseup', () => isDragging = false);

// ✅ Scroll to zoom
container.addEventListener('wheel', e => {
    e.preventDefault();
    const zoomFactor = 1.1;
    const mouseX = e.clientX - container.offsetLeft;
    const mouseY = e.clientY - container.offsetTop;

    if (e.deltaY < 0) {
        zoom *= zoomFactor;
        panX = mouseX - (mouseX - panX) * zoomFactor;
        panY = mouseY - (mouseY - panY) * zoomFactor;
    } else {
        zoom /= zoomFactor;
        zoom = Math.max(0.2, zoom);
        panX = mouseX - (mouseX - panX) / zoomFactor;
        panY = mouseY - (mouseY - panY) / zoomFactor;
    }
    applyTransform();
}, { passive: false });

// ✅ Progress bar using PDF.js loading task
pdfjsLib.getDocument({
    url: url,
    rangeChunkSize: 65536
}).onProgress = function(progressData) {
    let percent = Math.floor((progressData.loaded / progressData.total) * 100);
    progressFill.style.width = percent + '%';
    progressText.textContent = percent + '%';
};
</script>
</body>
</html>
